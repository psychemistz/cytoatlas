<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CytoAtlas Component Test</title>
    <link rel="stylesheet" href="/static/css/main.css">
    <style>
        body {
            padding: 2rem;
            font-family: 'Inter', system-ui, sans-serif;
        }
        .test-section {
            margin-bottom: 2rem;
            padding: 1rem;
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
        }
        .test-result {
            padding: 0.5rem;
            margin: 0.5rem 0;
            border-radius: 0.25rem;
        }
        .test-result.pass {
            background: #d1fae5;
            color: #065f46;
        }
        .test-result.fail {
            background: #fecaca;
            color: #b91c1c;
        }
        .chart-test {
            min-height: 300px;
            margin-top: 1rem;
        }
    </style>
</head>
<body>
    <h1>CytoAtlas Component Test Page</h1>
    <p>This page tests that all new components load correctly.</p>

    <!-- Test Results -->
    <div id="test-results"></div>

    <!-- Test Charts -->
    <div class="test-section">
        <h2>Chart Components</h2>
        <div id="test-heatmap" class="chart-test"></div>
        <div id="test-scatter" class="chart-test"></div>
        <div id="test-volcano" class="chart-test"></div>
    </div>

    <!-- Test Tab Panel -->
    <div class="test-section">
        <h2>Tab Panel</h2>
        <div id="test-tabs"></div>
    </div>

    <!-- Test Filter Bar -->
    <div class="test-section">
        <h2>Filter Bar</h2>
        <div id="test-filters"></div>
    </div>

    <!-- Test Export Button -->
    <div class="test-section">
        <h2>Export Button</h2>
        <div id="test-export"></div>
    </div>

    <!-- Load Scripts (same order as index.html) -->
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>

    <!-- Core -->
    <script src="/static/js/api.js"></script>
    <script src="/static/js/router.js"></script>
    <script src="/static/js/store.js"></script>
    <script src="/static/js/data-loader.js"></script>

    <!-- Chart Components -->
    <script src="/static/js/components/charts/heatmap-chart.js"></script>
    <script src="/static/js/components/charts/boxplot-chart.js"></script>
    <script src="/static/js/components/charts/scatter-chart.js"></script>
    <script src="/static/js/components/charts/volcano-chart.js"></script>
    <script src="/static/js/components/charts/bar-chart.js"></script>
    <script src="/static/js/components/charts/lollipop-chart.js"></script>
    <script src="/static/js/components/charts/violin-chart.js"></script>

    <!-- UI Components -->
    <script src="/static/js/components/tab-panel.js"></script>
    <script src="/static/js/components/filter-bar.js"></script>
    <script src="/static/js/components/loading-skeleton.js"></script>
    <script src="/static/js/components/export-button.js"></script>

    <!-- Test Script -->
    <script>
        const tests = [];

        function addTest(name, passed, message = '') {
            tests.push({ name, passed, message });
        }

        function runTests() {
            // Test 1: Check if all classes are defined
            addTest('HeatmapChart', typeof HeatmapChart !== 'undefined');
            addTest('BoxplotChart', typeof BoxplotChart !== 'undefined');
            addTest('ScatterChart', typeof ScatterChart !== 'undefined');
            addTest('VolcanoChart', typeof VolcanoChart !== 'undefined');
            addTest('BarChart', typeof BarChart !== 'undefined');
            addTest('LollipopChart', typeof LollipopChart !== 'undefined');
            addTest('ViolinChart', typeof ViolinChart !== 'undefined');
            addTest('TabPanel', typeof TabPanel !== 'undefined');
            addTest('FilterBar', typeof FilterBar !== 'undefined');
            addTest('LoadingSkeleton', typeof LoadingSkeleton !== 'undefined');
            addTest('ExportButton', typeof ExportButton !== 'undefined');
            addTest('AppState', typeof appState !== 'undefined');
            addTest('DataLoader', typeof dataLoader !== 'undefined');

            // Test 2: Create instances
            try {
                const heatmap = new HeatmapChart('test-heatmap');
                heatmap.render({
                    z: [[1, 2, 3], [4, 5, 6]],
                    x: ['A', 'B', 'C'],
                    y: ['Row1', 'Row2']
                });
                addTest('HeatmapChart Instance', true, 'Rendered successfully');
            } catch (e) {
                addTest('HeatmapChart Instance', false, e.message);
            }

            try {
                const scatter = new ScatterChart('test-scatter');
                scatter.render({
                    x: [1, 2, 3, 4, 5],
                    y: [2, 4, 5, 4, 5],
                    labels: ['A', 'B', 'C', 'D', 'E']
                });
                addTest('ScatterChart Instance', true, 'Rendered successfully');
            } catch (e) {
                addTest('ScatterChart Instance', false, e.message);
            }

            try {
                const volcano = new VolcanoChart('test-volcano');
                volcano.render({
                    points: [
                        { signature: 'Gene1', activity_diff: 2.5, p_value: 0.001 },
                        { signature: 'Gene2', activity_diff: -1.8, p_value: 0.01 },
                        { signature: 'Gene3', activity_diff: 0.5, p_value: 0.5 }
                    ]
                });
                addTest('VolcanoChart Instance', true, 'Rendered successfully');
            } catch (e) {
                addTest('VolcanoChart Instance', false, e.message);
            }

            try {
                const tabPanel = new TabPanel('test-tabs');
                tabPanel.addTab('tab1', 'Tab 1', async () => '<p>Tab 1 Content</p>');
                tabPanel.addTab('tab2', 'Tab 2', async () => '<p>Tab 2 Content</p>');
                tabPanel.init();
                addTest('TabPanel Instance', true, 'Created with 2 tabs');
            } catch (e) {
                addTest('TabPanel Instance', false, e.message);
            }

            try {
                const filterBar = new FilterBar('test-filters');
                filterBar.addToggle('test', [
                    { value: 'a', label: 'Option A' },
                    { value: 'b', label: 'Option B' }
                ]);
                addTest('FilterBar Instance', true, 'Created with toggle');
            } catch (e) {
                addTest('FilterBar Instance', false, e.message);
            }

            try {
                const exportBtn = new ExportButton('test-export', {
                    formats: ['CSV', 'PNG']
                });
                addTest('ExportButton Instance', true, 'Created with dropdown');
            } catch (e) {
                addTest('ExportButton Instance', false, e.message);
            }

            // Test 3: State management
            try {
                appState.set('testKey', 'testValue');
                const value = appState.get('testKey');
                addTest('AppState Set/Get', value === 'testValue');
            } catch (e) {
                addTest('AppState Set/Get', false, e.message);
            }

            // Test 4: Data loader
            try {
                addTest('DataLoader Available', typeof dataLoader.load === 'function');
            } catch (e) {
                addTest('DataLoader Available', false, e.message);
            }

            // Render results
            renderResults();
        }

        function renderResults() {
            const container = document.getElementById('test-results');
            const passCount = tests.filter(t => t.passed).length;
            const totalCount = tests.length;

            let html = `
                <div class="test-section">
                    <h2>Test Results: ${passCount}/${totalCount} Passed</h2>
            `;

            tests.forEach(test => {
                html += `
                    <div class="test-result ${test.passed ? 'pass' : 'fail'}">
                        ${test.passed ? '✅' : '❌'} ${test.name}
                        ${test.message ? ` - ${test.message}` : ''}
                    </div>
                `;
            });

            html += '</div>';
            container.innerHTML = html;
        }

        // Run tests when page loads
        window.addEventListener('load', () => {
            setTimeout(runTests, 100);
        });
    </script>
</body>
</html>
