<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CytoAtlas - Pan-Disease Cytokine Activity Atlas</title>
    <meta name="description" content="Explore cytokine and secreted protein activities across 17+ million immune cells from multiple single-cell atlases">

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Plotly for visualizations -->
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>

    <!-- D3 for network visualizations -->
    <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>

    <!-- Styles -->
    <link rel="stylesheet" href="/static/css/main.css">
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-container">
            <a href="/" class="logo">
                <span class="logo-icon">&#128300;</span>
                <span class="logo-text">CytoAtlas</span>
            </a>

            <nav class="nav">
                <a href="/" class="nav-link active" data-page="home">Home</a>
                <a href="/search" class="nav-link" data-page="search">Search</a>
                <a href="/explore" class="nav-link" data-page="explore">Explore</a>
                <a href="/validate" class="nav-link" data-page="validate">Validate</a>
                <a href="/compare" class="nav-link" data-page="compare">Compare</a>
                <a href="/perturbation" class="nav-link" data-page="perturbation">Perturbation</a>
                <a href="/spatial" class="nav-link" data-page="spatial">Spatial</a>
                <a href="/submit" class="nav-link" data-page="submit">Submit</a>
                <a href="/chat" class="nav-link" data-page="chat">Chat</a>
                <a href="/about" class="nav-link" data-page="about">About</a>
            </nav>

            <div class="header-search">
                <input type="text" id="global-search" placeholder="Search genes (IFNG, TNF, IL6...)" class="search-input">
                <button class="search-btn" onclick="handleSearch()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="11" cy="11" r="8"></circle>
                        <path d="m21 21-4.35-4.35"></path>
                    </svg>
                </button>
            </div>

            <div class="header-actions">
                <a href="/docs" class="btn btn-secondary" target="_blank">API Docs</a>
                <!-- <a href="/login" class="btn btn-primary">Login</a> -->
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main id="app">
        <!-- Content will be loaded here by router -->
    </main>

    <!-- Footer -->
    <footer class="footer">
        <div class="footer-container">
            <div class="footer-info">
                <p>&copy; 2025 CytoAtlas. Developed at NIH/NCI.</p>
                <p>Data from CIMA, Inflammation Atlas, and scAtlas.</p>
            </div>
            <div class="footer-links">
                <a href="/docs" target="_blank">API Documentation</a>
                <a href="https://github.com/psychemistz/cytoatlas" target="_blank">GitHub</a>
            </div>
        </div>
    </footer>

    <!-- Templates -->
    <template id="home-template">
        <div class="page home-page">
            <!-- Hero Section -->
            <section class="hero">
                <div class="hero-content">
                    <h1 class="hero-title">Pan-Disease Cytokine Activity Atlas</h1>
                    <p class="hero-subtitle">
                        Explore cytokine and secreted protein activities across
                        <strong>17+ million immune cells</strong> from multiple single-cell atlases
                    </p>

                    <div class="hero-search">
                        <input type="text" id="hero-search-input" placeholder="Search genes (e.g., IFNG, TNF, IL6, IL17A...)" class="hero-search-input">
                        <button class="hero-search-btn" onclick="handleHeroSearch()">Search</button>
                    </div>

                    <div class="hero-examples">
                        <span>Try:</span>
                        <button class="example-btn" onclick="searchExample('IFNG')">IFNG</button>
                        <button class="example-btn" onclick="searchExample('TNF')">TNF</button>
                        <button class="example-btn" onclick="searchExample('IL6')">IL6</button>
                        <button class="example-btn" onclick="searchExample('IL17A')">IL17A</button>
                        <button class="example-btn" onclick="searchExample('TGFB1')">TGFB1</button>
                    </div>
                </div>
            </section>

            <!-- Stats Section -->
            <section class="stats-section">
                <div class="stats-container">
                    <div class="stat-card">
                        <div class="stat-value" id="stat-cells">17.8M</div>
                        <div class="stat-label">Total Cells</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="stat-cytokines">43</div>
                        <div class="stat-label">Cytokines (CytoSig)</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="stat-proteins">1,170</div>
                        <div class="stat-label">Proteins (SecAct)</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="stat-diseases">12+</div>
                        <div class="stat-label">Diseases</div>
                    </div>
                </div>
            </section>

            <!-- Atlas Cards Section -->
            <section class="atlases-section">
                <h2 class="section-title">Core Atlases</h2>
                <div class="atlas-cards" id="atlas-cards">
                    <!-- Cards will be loaded dynamically -->
                    <div class="loading">Loading atlases...</div>
                </div>
            </section>

            <!-- Features Section -->
            <section class="features-section">
                <h2 class="section-title">What You Can Do</h2>
                <div class="features-grid">
                    <div class="feature-card" onclick="router.navigate('/search')">
                        <div class="feature-icon">&#128270;</div>
                        <h3>Search</h3>
                        <p>Search genes to view expression and cytokine/protein activity across all atlases</p>
                        <div class="quick-links">
                            <a href="/gene/IFNG" onclick="event.stopPropagation()">IFNG</a>
                            <a href="/gene/TNF" onclick="event.stopPropagation()">TNF</a>
                            <a href="/gene/IL6" onclick="event.stopPropagation()">IL6</a>
                        </div>
                    </div>
                    <div class="feature-card" onclick="router.navigate('/explore')">
                        <div class="feature-icon">&#128202;</div>
                        <h3>Explore</h3>
                        <p>Interactive heatmaps, scatter plots, and correlation analyses</p>
                    </div>
                    <div class="feature-card" onclick="router.navigate('/validate')">
                        <div class="feature-icon">&#9989;</div>
                        <h3>Validate</h3>
                        <p>5-type credibility assessment for inference quality</p>
                    </div>
                    <div class="feature-card" onclick="router.navigate('/compare')">
                        <div class="feature-icon">&#128200;</div>
                        <h3>Compare</h3>
                        <p>Cross-atlas comparison of cytokine activities</p>
                    </div>
                    <div class="feature-card" onclick="router.navigate('/submit')">
                        <div class="feature-icon">&#128193;</div>
                        <h3>Submit</h3>
                        <p>Upload your H5AD data for CytoSig/SecAct inference</p>
                    </div>
                    <div class="feature-card" onclick="router.navigate('/chat')">
                        <div class="feature-icon">&#128172;</div>
                        <h3>Chat</h3>
                        <p>Ask questions with AI-powered natural language assistant</p>
                    </div>
                </div>
            </section>
        </div>
    </template>

    <template id="explore-template">
        <div class="page explore-page">
            <div class="page-header">
                <h1>Explore Atlases</h1>
                <p>Browse and analyze cytokine activities across single-cell atlases</p>
            </div>

            <div class="filters-bar">
                <select id="filter-type" class="filter-select">
                    <option value="all">All Types</option>
                    <option value="builtin">Core Atlases</option>
                    <option value="published">Published</option>
                    <option value="user">Community</option>
                </select>
                <select id="filter-tissue" class="filter-select">
                    <option value="all">All Tissues</option>
                    <option value="pbmc">PBMC</option>
                    <option value="tissue">Tissue</option>
                </select>
                <select id="sort-by" class="filter-select">
                    <option value="cells">Sort by Cells</option>
                    <option value="name">Sort by Name</option>
                    <option value="grade">Sort by Grade</option>
                </select>
            </div>

            <div class="atlas-list" id="atlas-list">
                <!-- Atlas cards will be loaded here -->
                <div class="loading">Loading atlases...</div>
            </div>
        </div>
    </template>

    <template id="atlas-detail-template">
        <div class="page atlas-detail-page">
            <div class="atlas-header" id="atlas-header">
                <!-- Atlas header will be loaded -->
            </div>

            <div class="analysis-tabs" id="analysis-tabs">
                <!-- Tabs will be loaded based on atlas -->
            </div>

            <div class="analysis-content" id="analysis-content">
                <!-- Analysis panels will be loaded here -->
            </div>
        </div>
    </template>

    <template id="validate-template">
        <div class="page validate-page">
            <div class="page-header">
                <h1>Activity Validation</h1>
                <p>Validation of activity predictions by correlating inferred scores with signature gene expression across multiple aggregation levels</p>
            </div>

            <div class="tab-navigation" id="validation-tabs">
                <button class="tab-btn active" data-tab="summary">Summary</button>
                <button class="tab-btn" data-tab="bulk-rnaseq">Bulk RNA-seq</button>
                <button class="tab-btn" data-tab="donor-level">Donor Level</button>
                <button class="tab-btn" data-tab="celltype-level">Cell Type Level</button>
                <button class="tab-btn" data-tab="singlecell">Single-Cell</button>
            </div>

            <div class="validation-content" id="validation-content">
                <!-- Tab content will be loaded dynamically by validate.js -->
            </div>
        </div>
    </template>

    <template id="compare-template">
        <div class="page compare-page">
            <!-- Compare page is fully rendered by compare.js -->
        </div>
    </template>

    <template id="about-template">
        <div class="page about-page">
            <div class="page-header">
                <h1>About</h1>
                <p>Computational methods and data sources used in the Pan-Disease Cytokine Activity Atlas</p>
            </div>

            <div class="about-container">
                <!-- Data Sources -->
                <div class="method-card">
                    <div class="method-card-header">
                        <div class="method-icon">&#128451;</div>
                        <h2>Data Sources</h2>
                    </div>
                    <div class="method-card-content">
                        <div class="data-source-grid">
                            <div class="data-source">
                                <h4>CIMA</h4>
                                <div class="data-stats">6.5M cells · 421 donors</div>
                                <p>Healthy adult immune profiling with matched blood biochemistry and metabolomics</p>
                            </div>
                            <div class="data-source">
                                <h4>Inflammation Atlas</h4>
                                <div class="data-stats">4.9M cells · 817 samples</div>
                                <p>Pan-disease immune profiling across inflammatory conditions (RA, IBD, MS, SLE)</p>
                            </div>
                            <div class="data-source">
                                <h4>scAtlas Normal</h4>
                                <div class="data-stats">2.3M cells · 35 organs</div>
                                <p>Human tissue reference atlas with 376 cell types from the Human Cell Atlas</p>
                            </div>
                            <div class="data-source">
                                <h4>scAtlas Cancer</h4>
                                <div class="data-stats">4.1M cells · 464 donors</div>
                                <p>Pan-cancer immune profiling with 156 cell type annotations</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Activity Inference -->
                <div class="method-card">
                    <div class="method-card-header">
                        <div class="method-icon">&#128300;</div>
                        <h2>Cytokine Activity Inference</h2>
                    </div>
                    <div class="method-card-content">
                        <p>Cytokine signaling activities were inferred from single-cell RNA-seq data using two complementary approaches:</p>
                        <div class="method-item">
                            <h4>CytoSig</h4>
                            <p>Predicts activities of <strong>43 cytokines</strong> based on their downstream transcriptional signatures. Ridge regression is used to infer activity from signature gene expression.</p>
                            <div class="method-citation">Jiang et al. (2021) <em>Nature Methods</em></div>
                        </div>
                        <div class="method-item">
                            <h4>SecAct</h4>
                            <p>Estimates activities of <strong>1,170 secreted proteins</strong> using signatures learned from spatial Moran's I autocorrelation patterns.</p>
                            <div class="method-citation">Ru et al. (2026) <em>Nature Methods</em></div>
                        </div>
                        <p class="method-note">Activity scores are z-scored ridge regression coefficients. Positive values indicate upregulation of downstream targets.</p>
                    </div>
                </div>

                <!-- Statistical Methods -->
                <div class="method-card">
                    <div class="method-card-header">
                        <div class="method-icon">&#128202;</div>
                        <h2>Statistical Analysis</h2>
                    </div>
                    <div class="method-card-content">
                        <div class="method-item">
                            <h4>Correlation Analysis</h4>
                            <p>Spearman's rank correlation (ρ) for continuous variables (age, BMI, biochemistry). P-values adjusted with Benjamini-Hochberg FDR.</p>
                        </div>
                        <div class="method-item">
                            <h4>Differential Analysis</h4>
                            <p>Mann-Whitney U test for two-group comparisons. Effect sizes reported as activity difference (Δ) in z-score units.</p>
                        </div>
                        <div class="method-item">
                            <h4>Meta-Analysis</h4>
                            <p>Fixed-effects meta-analysis with inverse-variance weighting. Heterogeneity assessed via I² statistic.</p>
                            <div class="i2-scale">
                                <span class="i2-low">I² &lt; 25%: Low</span>
                                <span class="i2-mod">25-50%: Moderate</span>
                                <span class="i2-sub">50-75%: Substantial</span>
                                <span class="i2-high">&gt; 75%: High</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Validation -->
                <div class="method-card">
                    <div class="method-card-header">
                        <div class="method-icon">&#9989;</div>
                        <h2>Activity Validation</h2>
                    </div>
                    <div class="method-card-content">
                        <p>Activity predictions validated by correlating predicted scores with signature gene expression:</p>
                        <div class="validation-levels">
                            <div class="validation-level">
                                <h4>Pseudobulk Level</h4>
                                <p>Mean expression vs. activity per sample × cell type (highest correlations)</p>
                            </div>
                            <div class="validation-level">
                                <h4>Single-Cell Level</h4>
                                <p>Per-cell expression vs. activity (reflects biological variability)</p>
                            </div>
                            <div class="validation-level">
                                <h4>Atlas Level</h4>
                                <p>Mean values across cell types (demonstrates cell type patterns)</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Cross-Atlas Integration -->
                <div class="method-card">
                    <div class="method-card-header">
                        <div class="method-icon">&#128279;</div>
                        <h2>Cross-Atlas Integration</h2>
                    </div>
                    <div class="method-card-content">
                        <p>Cell type annotations harmonized using manual mapping based on canonical marker genes.</p>
                        <p>Signature conservation assessed via Spearman correlation across harmonized cell types:</p>
                        <div class="conservation-scale">
                            <div class="conservation-item high">
                                <strong>Highly Conserved</strong>
                                <span>r &gt; 0.7 in 2+ atlas pairs</span>
                            </div>
                            <div class="conservation-item mod">
                                <strong>Moderately Conserved</strong>
                                <span>r &gt; 0.5 in 2+ atlas pairs</span>
                            </div>
                            <div class="conservation-item low">
                                <strong>Atlas-Specific</strong>
                                <span>Low correlation across pairs</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- References -->
                <div class="method-card references-card">
                    <div class="method-card-header">
                        <div class="method-icon">&#128218;</div>
                        <h2>References</h2>
                    </div>
                    <div class="method-card-content">
                        <h4>Methods</h4>
                        <ol class="references-list">
                            <li><strong>Jiang et al.</strong> (2021) Systematic investigation of cytokine signaling activity at the tissue and single-cell levels. <em>Nature Methods</em> 18:1181-1191</li>
                            <li><strong>Ru et al.</strong> (2026) Inference of secreted protein activities in intercellular communication. <em>Nature Methods</em> (in press)</li>
                            <li><strong>Higgins et al.</strong> (2003) Measuring inconsistency in meta-analyses. <em>BMJ</em> 327:557-560</li>
                        </ol>
                        <h4>Data Sources</h4>
                        <ol class="references-list" start="4">
                            <li><strong>Yin et al.</strong> (2026) Chinese immune multi-omics atlas. <em>Science</em> 391:eadt3130</li>
                            <li><strong>Jiménez-Gracia et al.</strong> (2026) Interpretable inflammation landscape of circulating immune cells. <em>Nature Medicine</em></li>
                            <li><strong>Shi et al.</strong> (2025) Cross-tissue multicellular coordination and its rewiring in cancer. <em>Nature</em></li>
                        </ol>
                    </div>
                </div>
            </div>
        </div>
    </template>

    <template id="submit-template">
        <div class="page submit-page">
            <div class="page-header">
                <h1>Submit Your Dataset</h1>
                <p>Upload your single-cell dataset for CytoSig/SecAct activity inference</p>
            </div>

            <div class="submit-form">
                <div class="upload-zone" id="upload-zone">
                    <div class="upload-icon">&#128193;</div>
                    <p>Drag and drop H5AD file here, or click to browse</p>
                    <p class="upload-hint">Supported format: .h5ad (AnnData) | Max size: 50 GB</p>
                    <input type="file" id="file-input" accept=".h5ad" hidden>
                </div>

                <div class="submit-fields">
                    <div class="form-group">
                        <label for="dataset-name">Dataset Name</label>
                        <input type="text" id="dataset-name" placeholder="My Immune Atlas">
                    </div>
                    <div class="form-group">
                        <label for="dataset-desc">Description</label>
                        <textarea id="dataset-desc" placeholder="Single-cell profiling of..."></textarea>
                    </div>
                    <div class="form-group">
                        <label for="cell-type-col">Cell Type Column</label>
                        <select id="cell-type-col">
                            <option value="">Auto-detect from obs</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="sample-col">Sample Column</label>
                        <select id="sample-col">
                            <option value="">Auto-detect from obs</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Visibility</label>
                        <div class="radio-group">
                            <label><input type="radio" name="visibility" value="private" checked> Private</label>
                            <label><input type="radio" name="visibility" value="public"> Public</label>
                            <label><input type="radio" name="visibility" value="unlisted"> Unlisted</label>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="doi">Publication DOI (optional)</label>
                        <input type="text" id="doi" placeholder="10.1038/s41586-024-xxxxx">
                    </div>
                </div>

                <div class="submit-actions">
                    <button class="btn btn-secondary" onclick="router.navigate('/')">Cancel</button>
                    <button class="btn btn-primary" onclick="submitDataset()" disabled>Submit for Processing</button>
                </div>

                <p class="submit-note">Processing typically takes 2-4 hours per million cells</p>
            </div>
        </div>
    </template>

    <!-- JavaScript -->
    <!-- Core -->
    <script src="/static/js/api.js"></script>
    <script src="/static/js/router.js"></script>
    <script src="/static/js/store.js"></script>
    <script src="/static/js/data-loader.js"></script>

    <!-- Chart Components -->
    <script src="/static/js/components/charts/heatmap-chart.js"></script>
    <script src="/static/js/components/charts/boxplot-chart.js"></script>
    <script src="/static/js/components/charts/scatter-chart.js"></script>
    <script src="/static/js/components/charts/volcano-chart.js"></script>
    <script src="/static/js/components/charts/bar-chart.js"></script>
    <script src="/static/js/components/charts/lollipop-chart.js"></script>
    <script src="/static/js/components/charts/violin-chart.js"></script>

    <!-- UI Components -->
    <script src="/static/js/components/atlas-card.js"></script>
    <script src="/static/js/components/heatmap.js"></script>
    <script src="/static/js/components/scatter.js"></script>
    <script src="/static/js/components/chat-viz.js"></script>
    <script src="/static/js/components/chat-widget.js"></script>
    <script src="/static/js/components/sankey.js"></script>
    <script src="/static/js/components/forest-plot.js"></script>
    <script src="/static/js/components/tab-panel.js"></script>
    <script src="/static/js/components/filter-bar.js"></script>
    <script src="/static/js/components/loading-skeleton.js"></script>
    <script src="/static/js/components/export-button.js"></script>

    <!-- Pages -->
    <script src="/static/js/pages/home.js"></script>
    <script src="/static/js/pages/explore.js"></script>
    <script src="/static/js/pages/atlas-detail.js"></script>
    <script src="/static/js/pages/validate.js"></script>
    <script src="/static/js/pages/compare.js"></script>
    <script src="/static/js/pages/about.js"></script>
    <script src="/static/js/pages/search.js"></script>
    <script src="/static/js/pages/gene-detail.js"></script>
    <script src="/static/js/pages/submit.js"></script>
    <script src="/static/js/pages/chat.js"></script>
    <script src="/static/js/pages/perturbation.js"></script>
    <script src="/static/js/pages/spatial.js"></script>

    <!-- App Initialization -->
    <script src="/static/js/app.js"></script>
</body>
</html>
