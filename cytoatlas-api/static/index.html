<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CytoAtlas - Pan-Disease Cytokine Activity Atlas</title>
    <meta name="description" content="Explore cytokine and secreted protein activities across 17+ million immune cells from multiple single-cell atlases">

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Plotly for visualizations -->
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>

    <!-- D3 for network visualizations -->
    <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>

    <!-- Styles -->
    <link rel="stylesheet" href="/static/css/main.css">
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-container">
            <a href="/" class="logo">
                <span class="logo-icon">&#128300;</span>
                <span class="logo-text">CytoAtlas</span>
            </a>

            <nav class="nav">
                <a href="/" class="nav-link active" data-page="home">Home</a>
                <a href="/search" class="nav-link" data-page="search">Search</a>
                <a href="/explore" class="nav-link" data-page="explore">Explore</a>
                <a href="/validate" class="nav-link" data-page="validate">Validate</a>
                <a href="/compare" class="nav-link" data-page="compare">Compare</a>
                <a href="/submit" class="nav-link" data-page="submit">Submit</a>
                <a href="/chat" class="nav-link" data-page="chat">Chat</a>
            </nav>

            <div class="header-search">
                <input type="text" id="global-search" placeholder="Search genes (IFNG, TNF, IL6...)" class="search-input">
                <button class="search-btn" onclick="handleSearch()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="11" cy="11" r="8"></circle>
                        <path d="m21 21-4.35-4.35"></path>
                    </svg>
                </button>
            </div>

            <div class="header-actions">
                <a href="/docs" class="btn btn-secondary" target="_blank">API Docs</a>
                <!-- <a href="/login" class="btn btn-primary">Login</a> -->
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main id="app">
        <!-- Content will be loaded here by router -->
    </main>

    <!-- Footer -->
    <footer class="footer">
        <div class="footer-container">
            <div class="footer-info">
                <p>&copy; 2025 CytoAtlas. Developed at NIH/NCI.</p>
                <p>Data from CIMA, Inflammation Atlas, and scAtlas.</p>
            </div>
            <div class="footer-links">
                <a href="/docs" target="_blank">API Documentation</a>
                <a href="https://github.com/psychemistz/cytoatlas" target="_blank">GitHub</a>
            </div>
        </div>
    </footer>

    <!-- Templates -->
    <template id="home-template">
        <div class="page home-page">
            <!-- Hero Section -->
            <section class="hero">
                <div class="hero-content">
                    <h1 class="hero-title">Pan-Disease Cytokine Activity Atlas</h1>
                    <p class="hero-subtitle">
                        Explore cytokine and secreted protein activities across
                        <strong>17+ million immune cells</strong> from multiple single-cell atlases
                    </p>

                    <div class="hero-search">
                        <input type="text" id="hero-search-input" placeholder="Search genes (e.g., IFNG, TNF, IL6, IL17A...)" class="hero-search-input">
                        <button class="hero-search-btn" onclick="handleHeroSearch()">Search</button>
                    </div>

                    <div class="hero-examples">
                        <span>Try:</span>
                        <button class="example-btn" onclick="searchExample('IFNG')">IFNG</button>
                        <button class="example-btn" onclick="searchExample('TNF')">TNF</button>
                        <button class="example-btn" onclick="searchExample('IL6')">IL6</button>
                        <button class="example-btn" onclick="searchExample('IL17A')">IL17A</button>
                        <button class="example-btn" onclick="searchExample('TGFB1')">TGFB1</button>
                    </div>
                </div>
            </section>

            <!-- Stats Section -->
            <section class="stats-section">
                <div class="stats-container">
                    <div class="stat-card">
                        <div class="stat-value" id="stat-cells">17.8M</div>
                        <div class="stat-label">Total Cells</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="stat-cytokines">43</div>
                        <div class="stat-label">Cytokines (CytoSig)</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="stat-proteins">1,170</div>
                        <div class="stat-label">Proteins (SecAct)</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="stat-diseases">12+</div>
                        <div class="stat-label">Diseases</div>
                    </div>
                </div>
            </section>

            <!-- Atlas Cards Section -->
            <section class="atlases-section">
                <h2 class="section-title">Core Atlases</h2>
                <div class="atlas-cards" id="atlas-cards">
                    <!-- Cards will be loaded dynamically -->
                    <div class="loading">Loading atlases...</div>
                </div>
            </section>

            <!-- Features Section -->
            <section class="features-section">
                <h2 class="section-title">What You Can Do</h2>
                <div class="features-grid">
                    <div class="feature-card" onclick="router.navigate('/search')">
                        <div class="feature-icon">&#128270;</div>
                        <h3>Search</h3>
                        <p>Search genes to view expression and cytokine/protein activity across all atlases</p>
                        <div class="quick-links">
                            <a href="/gene/IFNG" onclick="event.stopPropagation()">IFNG</a>
                            <a href="/gene/TNF" onclick="event.stopPropagation()">TNF</a>
                            <a href="/gene/IL6" onclick="event.stopPropagation()">IL6</a>
                        </div>
                    </div>
                    <div class="feature-card" onclick="router.navigate('/explore')">
                        <div class="feature-icon">&#128202;</div>
                        <h3>Explore</h3>
                        <p>Interactive heatmaps, scatter plots, and correlation analyses</p>
                    </div>
                    <div class="feature-card" onclick="router.navigate('/validate')">
                        <div class="feature-icon">&#9989;</div>
                        <h3>Validate</h3>
                        <p>5-type credibility assessment for inference quality</p>
                    </div>
                    <div class="feature-card" onclick="router.navigate('/compare')">
                        <div class="feature-icon">&#128200;</div>
                        <h3>Compare</h3>
                        <p>Cross-atlas comparison of cytokine activities</p>
                    </div>
                    <div class="feature-card" onclick="router.navigate('/submit')">
                        <div class="feature-icon">&#128193;</div>
                        <h3>Submit</h3>
                        <p>Upload your H5AD data for CytoSig/SecAct inference</p>
                    </div>
                    <div class="feature-card" onclick="router.navigate('/chat')">
                        <div class="feature-icon">&#128172;</div>
                        <h3>Chat</h3>
                        <p>Ask questions with AI-powered natural language assistant</p>
                    </div>
                </div>
            </section>

            <!-- Methods Section -->
            <section class="methods-section">
                <h2 class="section-title">Methods</h2>
                <div class="methods-content">
                    <div class="method-block">
                        <h3>Cytokine Activity Inference</h3>
                        <p>Cytokine signaling activities were inferred from single-cell RNA-seq data using two complementary approaches:</p>
                        <ul>
                            <li><strong>CytoSig</strong>: Predicts activities of 43 cytokines based on their downstream transcriptional signatures (Jiang et al., 2021).</li>
                            <li><strong>SecAct</strong>: Estimates activities of 1,170 secreted proteins using secreted protein signatures learned from spatial Moran's I autocorrelation (Ru et al., 2026).</li>
                        </ul>
                        <p>Activity scores represent z-scored coefficients from ridge regression of signature gene expression, where positive values indicate upregulation of downstream targets.</p>
                    </div>

                    <div class="method-block">
                        <h3>Data Sources</h3>
                        <ul>
                            <li><strong>CIMA (Healthy Immune)</strong>: 6.5M cells from 421 healthy donors with matched blood biochemistry and metabolomics</li>
                            <li><strong>Inflammation Atlas</strong>: 4.9M cells from 817 samples across inflammatory diseases (RA, IBD, MS, SLE, etc.)</li>
                            <li><strong>scAtlas Normal</strong>: 2.3M cells spanning 35 organs and 376 cell types from the Human Cell Atlas</li>
                            <li><strong>scAtlas Cancer</strong>: 4.1M cells from pan-cancer datasets with 156 cell type annotations</li>
                        </ul>
                    </div>

                    <div class="method-block">
                        <h3>Statistical Analysis</h3>
                        <div class="method-subsection">
                            <h4>Correlation Analysis</h4>
                            <p>Spearman's rank correlation coefficient (ρ) was used for continuous variables (age, BMI, biochemistry, metabolites). P-values were adjusted using Benjamini-Hochberg FDR correction.</p>
                        </div>
                        <div class="method-subsection">
                            <h4>Differential Analysis</h4>
                            <p>Mann-Whitney U test (Wilcoxon rank-sum) was used for two-group comparisons (sex, disease vs. healthy). Effect sizes are reported as activity difference (Δ, z-score units).</p>
                        </div>
                        <div class="method-subsection">
                            <h4>Meta-Analysis</h4>
                            <p>Fixed-effects meta-analysis combines effect sizes across atlases using inverse-variance weighting. Heterogeneity was assessed using the I² statistic (Higgins et al., 2003), where I² < 25% indicates low heterogeneity and I² > 75% indicates considerable heterogeneity.</p>
                        </div>
                    </div>

                    <div class="method-block">
                        <h3>Cross-Atlas Integration</h3>
                        <p>Cell type annotations were harmonized across atlases using manual mapping dictionaries based on canonical marker genes and established nomenclature. Signature conservation is assessed by computing Spearman correlation of activity values across harmonized cell types between atlas pairs:</p>
                        <ul>
                            <li><strong>Highly Conserved</strong>: Spearman r > 0.7 in at least 2 of 3 atlas pairs</li>
                            <li><strong>Moderately Conserved</strong>: Spearman r > 0.5 in at least 2 atlas pairs</li>
                            <li><strong>Atlas-Specific</strong>: Low correlation across available pairs</li>
                        </ul>
                    </div>

                    <div class="method-block">
                        <h3>Activity Validation</h3>
                        <p>Activity predictions are validated by computing correlations between predicted activity scores and actual gene expression of signature genes at three levels:</p>
                        <ul>
                            <li><strong>Pseudobulk Level</strong>: Mean signature gene expression vs. activity per sample × cell type</li>
                            <li><strong>Single-Cell Level</strong>: Per-cell correlation between signature gene expression and activity</li>
                            <li><strong>Atlas Level</strong>: Mean expression vs. mean activity across cell types</li>
                        </ul>
                    </div>
                </div>
            </section>

            <!-- References Section -->
            <section class="references-section">
                <h2 class="section-title">References</h2>
                <div class="references-content">
                    <ol class="references-list">
                        <li>Ru et al. (2026) <em>Nature Methods</em> (in press) - Inference of secreted protein activities in intercellular communication</li>
                        <li>Jiang et al. (2021) <em>Nature Methods</em> - Systematic investigation of cytokine signaling activity at the tissue and single-cell levels</li>
                        <li>Hao et al. (2021) <em>Cell</em> - Integrated analysis of multimodal single-cell data</li>
                        <li>Higgins et al. (2003) <em>BMJ</em> - Measuring inconsistency in meta-analyses</li>
                        <li>Domínguez Conde et al. (2022) <em>Science</em> - Cross-tissue immune cell analysis reveals tissue-specific features in humans</li>
                    </ol>
                </div>
            </section>
        </div>
    </template>

    <template id="explore-template">
        <div class="page explore-page">
            <div class="page-header">
                <h1>Explore Atlases</h1>
                <p>Browse and analyze cytokine activities across single-cell atlases</p>
            </div>

            <div class="filters-bar">
                <select id="filter-type" class="filter-select">
                    <option value="all">All Types</option>
                    <option value="builtin">Core Atlases</option>
                    <option value="published">Published</option>
                    <option value="user">Community</option>
                </select>
                <select id="filter-tissue" class="filter-select">
                    <option value="all">All Tissues</option>
                    <option value="pbmc">PBMC</option>
                    <option value="tissue">Tissue</option>
                </select>
                <select id="sort-by" class="filter-select">
                    <option value="cells">Sort by Cells</option>
                    <option value="name">Sort by Name</option>
                    <option value="grade">Sort by Grade</option>
                </select>
            </div>

            <div class="atlas-list" id="atlas-list">
                <!-- Atlas cards will be loaded here -->
                <div class="loading">Loading atlases...</div>
            </div>
        </div>
    </template>

    <template id="atlas-detail-template">
        <div class="page atlas-detail-page">
            <div class="atlas-header" id="atlas-header">
                <!-- Atlas header will be loaded -->
            </div>

            <div class="analysis-tabs" id="analysis-tabs">
                <!-- Tabs will be loaded based on atlas -->
            </div>

            <div class="analysis-content" id="analysis-content">
                <!-- Analysis panels will be loaded here -->
            </div>
        </div>
    </template>

    <template id="validate-template">
        <div class="page validate-page">
            <div class="page-header">
                <h1>Validation & Credibility Assessment</h1>
                <p>Assess the quality and reliability of CytoSig/SecAct inferences</p>
            </div>

            <div class="validation-controls">
                <select id="val-atlas" class="filter-select">
                    <option value="">Select Atlas</option>
                </select>
                <select id="val-signature" class="filter-select">
                    <option value="">Select Signature</option>
                </select>
                <select id="val-type" class="filter-select">
                    <option value="CytoSig">CytoSig</option>
                    <option value="SecAct">SecAct</option>
                </select>
            </div>

            <div class="validation-summary" id="validation-summary">
                <!-- Summary will be loaded -->
            </div>

            <div class="validation-panels" id="validation-panels">
                <!-- 6 validation panels -->
            </div>
        </div>
    </template>

    <template id="compare-template">
        <div class="page compare-page">
            <!-- Compare page is fully rendered by compare.js -->
        </div>
    </template>

    <template id="submit-template">
        <div class="page submit-page">
            <div class="page-header">
                <h1>Submit Your Dataset</h1>
                <p>Upload your single-cell dataset for CytoSig/SecAct activity inference</p>
            </div>

            <div class="submit-form">
                <div class="upload-zone" id="upload-zone">
                    <div class="upload-icon">&#128193;</div>
                    <p>Drag and drop H5AD file here, or click to browse</p>
                    <p class="upload-hint">Supported format: .h5ad (AnnData) | Max size: 50 GB</p>
                    <input type="file" id="file-input" accept=".h5ad" hidden>
                </div>

                <div class="submit-fields">
                    <div class="form-group">
                        <label for="dataset-name">Dataset Name</label>
                        <input type="text" id="dataset-name" placeholder="My Immune Atlas">
                    </div>
                    <div class="form-group">
                        <label for="dataset-desc">Description</label>
                        <textarea id="dataset-desc" placeholder="Single-cell profiling of..."></textarea>
                    </div>
                    <div class="form-group">
                        <label for="cell-type-col">Cell Type Column</label>
                        <select id="cell-type-col">
                            <option value="">Auto-detect from obs</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="sample-col">Sample Column</label>
                        <select id="sample-col">
                            <option value="">Auto-detect from obs</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Visibility</label>
                        <div class="radio-group">
                            <label><input type="radio" name="visibility" value="private" checked> Private</label>
                            <label><input type="radio" name="visibility" value="public"> Public</label>
                            <label><input type="radio" name="visibility" value="unlisted"> Unlisted</label>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="doi">Publication DOI (optional)</label>
                        <input type="text" id="doi" placeholder="10.1038/s41586-024-xxxxx">
                    </div>
                </div>

                <div class="submit-actions">
                    <button class="btn btn-secondary" onclick="router.navigate('/')">Cancel</button>
                    <button class="btn btn-primary" onclick="submitDataset()" disabled>Submit for Processing</button>
                </div>

                <p class="submit-note">Processing typically takes 2-4 hours per million cells</p>
            </div>
        </div>
    </template>

    <!-- JavaScript -->
    <script src="/static/js/api.js"></script>
    <script src="/static/js/router.js"></script>
    <script src="/static/js/components/atlas-card.js"></script>
    <script src="/static/js/components/heatmap.js"></script>
    <script src="/static/js/components/scatter.js"></script>
    <script src="/static/js/components/chat-viz.js"></script>
    <script src="/static/js/components/chat-widget.js"></script>
    <script src="/static/js/components/sankey.js"></script>
    <script src="/static/js/components/forest-plot.js"></script>
    <script src="/static/js/pages/home.js"></script>
    <script src="/static/js/pages/explore.js"></script>
    <script src="/static/js/pages/atlas-detail.js"></script>
    <script src="/static/js/pages/validate.js"></script>
    <script src="/static/js/pages/compare.js"></script>
    <script src="/static/js/pages/search.js"></script>
    <script src="/static/js/pages/gene-detail.js"></script>
    <script src="/static/js/pages/submit.js"></script>
    <script src="/static/js/pages/chat.js"></script>
    <script src="/static/js/app.js"></script>
</body>
</html>
